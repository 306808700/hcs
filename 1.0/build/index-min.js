/*! hcs - v1.0 - 2013-10-23 11:47:15 AM
* Copyright (c) 2013 changyuan.lcy; Licensed  */
KISSY.add("gallery/hcs/1.0/index",function(S){function HCS(a){this.config=a||{},this.current=null,this.init()}var $=S.all,D=S.DOM,DOMNUM=0;return HCS.prototype.init=function(){this.view(),this.event(),this.tool()},HCS.prototype.view=function(){var a=this;this.tpl={wrap:"<hcsplate class='hcs_wrap'></hcsplate>",place:"<hcsplate class='hcs_place'></hcsplate>",input:"<input type='text' class='hcs_input' placeholder='BODY' />"},this.$wrap=$(this.tpl.wrap),this.$input=$(this.tpl.input),this.$wrap.append(this.$input),localStorage.hcs&&(document.getElementsByTagName("html")[0].innerHTML=localStorage.hcs),0==$("hcsplate").length&&$("body").after(this.$wrap).after($(this.tpl.place));var b=+new Date;$("head").append('<link href="../index.css?t='+b+'" rel="stylesheet" charset="utf-8" style="display:none !important " class="hcs_style">'),this.current=$("body"),this.view.current=function(){$("html").all(".hcs_current").removeClass("hcs_current").removeAttr("contenteditable"),a.current.addClass("hcs_current"),a.current.attr("contenteditable",!0)},this.view.uncurrent=function(){$("html").all(".hcs_current").removeClass("hcs_current").removeAttr("contenteditable")},this.view.addMark=function(a){function b(b){d+="__"+b+"="+$(a).attr(b)}var c,d="";c=$(a).one(".hcs_dev_span")?$(a).one(".hcs_dev_span"):$("<hcs class='hcs_dev_span' contenteditable='false'></hcs>");var e=$(a).attr("id"),f=$(a).attr("class"),g=$(a)[0].tagName;return f&&(f=f.replace(/hcs_dev/,"").replace(/hcs_current/,"")),d=e?e:f?g+"."+f:g,$(a).attr("src")&&b("src"),$(a).attr("href")&&b("href"),$(a).attr("charset")&&b("charset"),"::before{content:'"+d+"';}"},this.view.dev=function(){var b="";S.each($(document).all("*"),function(c){if("HTML"!=$(c)[0].tagName&&"SCRIPT"!=$(c)[0].tagName&&"HCS"!=$(c)[0].tagName&&"HCSPLATE"!=$(c)[0].tagName&&"hcs_input"!=$(c).attr("class")){$(c).attr("hcs",DOMNUM),DOMNUM++;var d=$(c).attr("hcs");b+="[hcs='"+d+"']"+a.view.addMark(c),$(c).addClass("hcs_dev")}}),0==$("style.hcs_style").length&&$("head").append($("<style class='hcs_style'></style>")),$style=$("style.hcs_style"),$style.html(b),a.view.current()},this.view.undev=function(){a.view.uncurrent(),$("html").all(".hcs_dev").removeClass("hcs_dev"),$("html").all(".hcs_dev_span").remove(),$("hcs").remove(),$(".hcs_style").remove(),$(".hcs_script").remove(),S.each($(document).all("*"),function(a){""==$(a).attr("class")&&$(a).removeAttr("class"),$(a).removeAttr("hcs")})},this.view.undevplate=function(){$("hcsplate").remove(),S.each($("html").all("script"),function(a){$(a).attr("src")&&-1!=$(a).attr("src").indexOf("hcs")&&$(a).remove()}),S.each($("html").all("link"),function(a){$(a).attr("href")&&-1!=$(a).attr("href").indexOf("hcs")&&$(a).remove()})},this.view.dev()},HCS.prototype.event=function(){var a=this;this.$input.on("keyup",function(b){13==b.keyCode&&(a.render($(this).val()),a._catchCommand($(this).val()),$(this).val("").fire("focus"))}).on("keydown",function(b){if(38==b.keyCode&&a._command_history[a._i-1]&&($(this).val(a._command_history[a._i-1]),$(this).fire("focus"),a._i--,setTimeout(function(){a.$input[0].selectionStart=a.$input[0].value.length},1)),40==b.keyCode){if(""==$(this).val())return;var c=a._command_history[a._i+1]||"";$(this).val(c),$(this).fire("focus"),a._i++}return 9==b.keyCode?(""==$(this).val()&&a.current.fire("focus"),"ap"==$(this).val()&&$(this).val("append "),"af"==$(this).val()&&$(this).val("after  "),"pr"==$(this).val()&&$(this).val("prev "),"ne"==$(this).val()&&$(this).val("next "),"be"==$(this).val()&&$(this).val("before "),"chil"==$(this).val()&&$(this).val("children "),"par"==$(this).val()&&$(this).val("parent "),!1):void 0}).fire("focus"),$(document).on("click",function(b){$(b.target).hasClass("hcs_dev")&&(a.tool._setcur($(b.target)),a.current.fire("focus")),$(b.target).hasClass("hcs_current")}).on("keydown",function(){}),window.onbeforeunload=function(){return"\u5982\u679c\u8fd8\u672a\u4fdd\u5b58\uff0c\u8bf7\u6267\u884c\u547d\u4ee4 save"},a._command_history=[],a._catchCommand=function(b){a._command_history[a._command_history.length-1]!=b&&a._command_history.push(b),a._i=a._command_history.length}},HCS.prototype.tool=function(){var a=this;a.tool._setcur=function(b,c){if(b){if("object"==typeof b)a.current=$(b);else if("relative"==c){if("HCS"==$(D[b](a.current))[0].tagName)return;a.current=$(D[b](a.current))}else a.current=$(b);if("object"==typeof a.current&&a.current.length>0){var d=a.current.attr("id"),e=a.current.attr("class");a.current.index();var f=a.current[0].tagName;e&&(e=e.replace(/hcs_dev/,"").replace(/hcs_current/,"")),d?a.$input.attr("placeholder",d):e?a.$input.attr("placeholder",f+"."+e):a.$input.attr("placeholder",f)}a.view.current()}},a.tool._setAttr=function(b){var c=b.match(/^#[a-zA-Z_]*/g),d=b.match(/\.[a-zA-Z_+-\s]*/g),e=b.match(/&[a-zA-Z_\d]*=["'.a-zA-Z_\d#_-]*|&[a-zA-Z_\d]*/g);if(c&&c.length>0&&a.current.attr("id",c[0].replace("#","")),d&&d.length>0)if(-1!=d[0].indexOf("+"))for(var f=d[0].replace(".+",""),g=f.split(" "),h=0;h<g.length;h++)a.current.addClass(g[h]);else if(-1!=d[0].indexOf("-"))for(var f=d[0].replace(".-",""),g=f.split(" "),h=0;h<g.length;h++)a.current.removeClass(g[h]);else for(var h=0;h<d.length;h++)a.current.removeAttr("class"),a.current.addClass(d[h].replace(".",""));if(e&&e.length>0)if(-1!=e[0].indexOf("-")){var f=e[0].replace(".-","");a.current.removeAttr(f)}else for(var h=0,i=e.length;i>h;h++){var j=e[h].split("=")[0].replace(/[&'"]/,""),k=e[h].split("=")[1]||"";a.current.attr(j,k)}},a.tool._getEl=function(b){if(-1!=b.indexOf("--")){if(b=b.replace("--",""),-1!=b.indexOf(":")){var c=b.split(":");return $($(c[0])[c[1]])}if($(b).length&&$(b)[0]!=a.current[0])return $(b)}if(-1!=b.indexOf('"'))return b=b.replace(/"/g,"");var d="<",e=b.indexOf(".")+1||b.indexOf("&")+1||b.indexOf("#")+1||b.match(/[a-z]*/)[0].length+1;if(d+=b.substring(0,e-1),-1!=b.indexOf(".")&&(d+=" class = "+b.match(/\.[a-z]*/g).join("").replace(/\./g,"")),-1!=b.indexOf("#")&&(d+=b.split("#")[0]+" id = "+b.split("#")[1]),-1!=b.indexOf("&"))for(var f=b.match(/&[a-zA-Z_\d]*=["'.a-zA-Z_\d#_-]*|&[a-zA-Z_\d]*/g),g=0,h=f.length;h>g;g++){var i=f[g].split("=")[0].replace(/[&'"]/,""),j=f[g].split("=")[1]||"";a.current.attr(i,j),d+=" "+i}if(d+="/>",-1!=b.indexOf("*"))for(var k=Number(b.match(/\*[\d]*/)[0].replace("*","")),l=d,g=1;k>g;g++)d+=l;try{var i=$(d);return i}catch(m){return b}}},HCS.prototype.render=function(value){function getDomList(a){if(a=a||self.tool._getEl(step[i]),i--,i>0){var b=self.tool._getEl(step[i]);b.append(a),getDomList(b)}else cur.append(a)}var self=this;self.command={rship:["parent","children","next","prev"],action:["append","before","after","prepend"]};var arr=value.split(" ");if(S.inArray(arr[0],self.command.rship)&&self.tool._setcur(arr[0],"relative"),"cd"==arr[0]&&self.tool._setcur(arr[1]),-1!="#.&".indexOf(value.charAt(0))&&self.tool._setAttr(value),S.inArray(arr[0],self.command.action)){var str=value.replace(arr[0]+" ","");if(!str)return;var cur;if(-1!=str.indexOf(">")){var step=str.split(">");cur=self.tool._getEl(step[0]);var i=step.length-1;getDomList()}else cur=self.tool._getEl(str);self.current[arr[0]](cur),"object"==typeof cur&&self.tool._setcur(cur)}if("change"==arr[0]){var html=self.current.html();self.current.html("");var temp=self.current[0].outerHTML.toString();temp=temp.replace(eval("/"+self.current[0].tagName.toUpperCase()+"/ig"),arr[1]);var cur=self.tool._getEl(temp);cur.html(html),self.current.after(cur),self.current.remove(),self.tool._setcur(cur)}if("html"==arr[0]&&(self.current.html(value.replace("html ","")),self.view.addMark(self.current)),"wrap"==arr[0]){var cur=self.tool._getEl(arr[1]);D.wrap(self.current,cur)}if("delete"==arr[0]){var cur=self.current.parent();self.current.remove(),self.tool._setcur(cur)}if("clear"==arr[0]&&(self.current.html(""),self.view.addMark(self.current)),"&&"==arr[0]&&self.current.removeAttr(arr[1]),".."==arr[0]&&self.current.removeClass(arr[1]),"find"==arr[0]&&self.current.removeClass(arr[1]),"copy"==arr[0]&&(self._copy=self.current.clone(!0)),"paste"==arr[0]&&self.current.append(self._copy),"dev"==arr[0]&&this.view.dev(),"undev"==arr[0])return this.view.undev(),void 0;if("css"==arr[0]){var link=$("<link href='"+arr[1]+"'' rel='stylesheet' />");$("head").append(link),self.tool._setcur(link)}if("js"==arr[0]){var script=document.createElement("script");script.setAttribute("type","text/javascript"),script.setAttribute("scr",arr[1]),document.head.appendChild(script),self.tool._setcur($(script))}if("reset"==arr[0]&&(delete localStorage.hcs,window.onbeforeunload=null,window.location.href=window.location.href),"save"==arr[0]){this.view.undev(),this.view.undevplate(),localStorage.hcs=$("html").html();var content=encodeURIComponent("<!doctype html>\n<html>\n"+localStorage.hcs+"\n</html>");if(arr[1]){var path="";self.config.path&&(path="&path="+self.config.path),S.IO.post("save.php?title="+arr[1]+"&content="+content+path)}this.init()}if("load"==arr[0]&&arr[1]){var path="";self.config.path&&(path=self.config.path);var time=+new Date;S.IO.post(path+arr[1]+".html?"+time,function(a){a=a.replace("<!doctype html>\n<html>\n","").replace("\n</html>",""),localStorage.hcs=a,$("html").html(localStorage.hcs),self.init()})}arr[0].match(/^\d*$/)&&self.tool._setcur(self.current[arr[0]]),self.view.dev()},HCS});